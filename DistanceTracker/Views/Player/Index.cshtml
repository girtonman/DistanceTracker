@using DistanceTracker.Models
@model Player

@{
	ViewData["Title"] = $"Player: {Model.Name}";
}

<script>
	var leaderboardRankings = [];
	var leaderboardSortingEnabled = false;
	var leaderboardRankingSort = 'asc';

	jQuery(function () {
		getGlobalStats();
		getLeaderboardRankings();
		getRecentActivity();
		$('#toggleLeaderboardRankingSort').click(() => {
			if (leaderboardSortingEnabled) {
				leaderboardSortingEnabled = false;

				// Toggle the sort order
				leaderboardRankingSort = leaderboardRankingSort == 'asc' ? 'desc' : 'asc';

				// Update the header arrow
				if (leaderboardRankingSort == 'asc') {
					$('#leaderboardRankingSortArrow').removeClass('fa-arrow-down');
					$('#leaderboardRankingSortArrow').addClass('fa-arrow-up');
				}
				else if (leaderboardRankingSort == 'desc') {
					$('#leaderboardRankingSortArrow').removeClass('fa-arrow-up');
					$('#leaderboardRankingSortArrow').addClass('fa-arrow-down');
				}

				// Sort and render
				handleLeaderboardRankings();
			}
		});
	});

	function getGlobalStats() {
		$.ajax({
			url: '/Player/GetGlobalStats',
			method: 'GET',
			data: {
				steamID: '@Model.SteamID'
			},
			success: function (data) {
				$('#globalRankPlaceholder').hide();
				$('#globalRank').show();
				$('#globalRank').html(data.globalLeaderboardEntry.rank);

				$('#globalPointsPlaceholder').hide();
				$('#globalPoints').show();
				$('#globalPoints').html(data.globalLeaderboardEntry.noodlePoints);

				$('#globalRatingPlaceholder').hide();
				$('#globalRating').show();
				$('#globalRating').html(data.globalLeaderboardEntry.playerRating);

				$('#globalRankImprovement').html(data.lastWeeksRankImprovement);
				$('#globalPointsImprovement').html(data.lastWeeksPointsImprovement);
				$('#globalRatingImprovement').html(data.lastWeeksRatingImprovement);
			},
			error: function () {
				toastr.error('Failed to load global stats for this player');
			}
		});
	};

	function getLeaderboardRankings() {
		$.ajax({
			url: '/Player/GetLeaderboardRankings',
			method: 'GET',
			data: {
				steamID: '@Model.SteamID'
			},
			success: function (data) {
				$('#leaderboardRankingsPlaceholder').hide();
				leaderboardRankings = data;
				handleLeaderboardRankings();
			},
			error: function () {
				toastr.error('Failed to load global stats for this player');
			}
		});
	};

	async function handleLeaderboardRankings() {
		// Sort the leaderboard entries
		if (leaderboardRankingSort == 'asc') {
			leaderboardRankings.sort((entry1, entry2) => {
				return entry1.rank - entry2.rank;
			});
		}
		else if (leaderboardRankingSort == 'desc') {
			leaderboardRankings.sort((entry1, entry2) => {
				return entry2.rank - entry1.rank;
			});
		}

		// Fill in the leaderboard rankings table
		var leaderboardRankingsTable = $('#leaderboardRankingsTable');
		leaderboardRankingsTable.html('');
		for (var i = 0; i < leaderboardRankings.length; i++) {
			var rankedEntry = leaderboardRankings[i];
			var row = $(`
			<tr>
				<td class="text-left"><div class="fade-in">
					<a class="link" href="/Leaderboard/Level?leaderboardID=${rankedEntry.leaderboard.id}">
						${rankedEntry.leaderboard.levelName}
					</a>
				</div></td>
				<td><div class="fade-in">${rankedEntry.rank}</div></td>
				<td><div class="fade-in">${rankedEntry.noodlePointsString}</div></td>
				<td><div class="fade-in">${rankedEntry.playerRatingString}</div></td>
			</tr>
		`);
			leaderboardRankingsTable.append(row);
			await new Promise(r => setTimeout(r, 15));
		}

		leaderboardSortingEnabled = true;
	};

	function getRecentActivity() {
		$.ajax({
			url: '/Player/GetRecentActivity',
			method: 'GET',
			data: {
				steamID: '@Model.SteamID'
			},
			success: async function (data) {
				$('#recentActivityPlaceholder').hide();
				var recentActivity = $('#recentActivity');
				for (var i = 0; i < data.length; i++) {
					var activity = data[i];
					if (activity.sighting != null) {
						var row = $(`
							<tr>
								<td class="text-left"><div class="fade-in">
									<a class="link" href="/Leaderboard/Level?leaderboardID=${activity.sighting.leaderboard.id}">
										${activity.sighting.leaderboard.levelName}
									</a>
								</div></td>
								<td><div class="fade-in">${/*TODO*/''}</div></td>
								<td><div class="fade-in">${activity.sighting.millisecondsString} <span class="text-success">New!</span></div></td>
								<td><div class="fade-in">${activity.timeAgoString}</div></td>
							</tr>
						`);
					}
					else {
						var row = $(`
							<tr>
								<td class="text-left"><div class="fade-in">
									<a class="link" href="/Leaderboard/Level?leaderboardID=${activity.improvement.leaderboard.id}">
										${activity.improvement.leaderboard.levelName}
									</a>
								</div></td>
								<td><div class="fade-in">
									${activity.improvement.newRank}
									( <i class="fas fa-arrow-up fa-sm text-success"></i> ${activity.improvement.oldRank - activity.improvement.newRank} )</div></td>
								<td><div class="fade-in">
									${activity.improvement.millisecondsString}
									( <i class="fas fa-arrow-up fa-sm text-success"></i> ${activity.improvement.timeImprovement} )</div></td>
								<td><div class="fade-in">${activity.timeAgoString}</div></td>
							</tr>
						`);
					}
					recentActivity.append(row);
					await new Promise(r => setTimeout(r, 15));
				}
			},
			error: function () {
				toastr.error('Failed to load recent activity for this player');
			}
		});
	};

</script>

<div class="text-center fade-in">
	<a href="http://steamcommunity.com/profiles/@Model.SteamID" target="_blank">
		<img href="" src="@await Model.GetSteamAvatar("_full")" />
	</a>
	<h1>@Model.Name</h1>
	<hr />

	<div class="row">
		<div class="col">
			<h5>Global Rank</h5>
			<div id="globalRankPlaceholder" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
			<h2 id="globalRank" class="odometer" style="display: none; margin-bottom: 1px; margin-top: -6px;"></h2>
			<h6>Last 7d: <i class="fas fa-arrow-up fa-sm text-success"></i> <span id="globalRankImprovement" class="odometer" style="margin-top: -2px;">0</span></h6>
		</div>
		<div class="col">
			<h5>Points</h5>
			<div id="globalPointsPlaceholder" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
			<h2 id="globalPoints" class="odometer" style="display: none; margin-bottom: 1px; margin-top: -6px;"></h2>
			<h6>Last 7d: <i class="fas fa-arrow-up fa-sm text-success"></i> <span id="globalPointsImprovement" class="odometer" style="margin-top: -2px;">0</span></h6>
		</div>
		<div class="col">
			<h5>Rating</h5>
			<div id="globalRatingPlaceholder" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
			<h2 id="globalRating" class="odometer" style="display: none; margin-bottom: 1px; margin-top: -6px;"></h2>
			<h6>Last 7d: <i class="fas fa-arrow-up fa-sm text-success"></i> <span id="globalRatingImprovement" class="odometer" style="margin-top: -2px;">0</span></h6>
		</div>
	</div>

	<hr style="border-top: 1px solid #c8c8c8"/>

	<div class="row">
		<div class="col-4">
			<h4 class="text-left">Track Rankings</h4>
			<table class="table table-striped table-dark" style="table-layout: fixed">
				<thead>
					<tr>
						<th class="text-left">Track</th>
						<th style="width: 100px">
							<span id="toggleLeaderboardRankingSort" class="pointer">Rank</span>&nbsp;
							<i id="leaderboardRankingSortArrow" class="fas fa-arrow-up fa-sm"></i></th>
						<th style="width: 100px">Points</th>
						<th style="width: 100px">Rating</th>
					</tr>
				</thead>
				<tbody id="leaderboardRankingsTable">
				</tbody>
			</table>
			<div id="leaderboardRankingsPlaceholder" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
		</div>
		<div class="col">
			<h4 class="text-left">Recent Activity</h4>
			<table class="table table-striped table-dark">
				<thead>
					<tr>
						<th class="text-left">Track</th>
						<th>Rank</th>
						<th>Time</th>
						<th>When</th>
					</tr>
				</thead>
				<tbody id="recentActivity">
				</tbody>
			</table>
			<div id="recentActivityPlaceholder" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
		</div>
	</div>

</div>
